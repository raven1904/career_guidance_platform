{% extends 'base.html' %}

{% block title %}{{ assessment.title }} - CareerGuide Pro{% endblock %}

{% block content %}
<div class="container">
  <div class="row mb-4">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'assessment_list' %}">Assessments</a></li>
          <li class="breadcrumb-item active">{{ assessment.title }}</li>
        </ol>
      </nav>

      <h2>{{ assessment.title }}</h2>
      <p class="text-muted">{{ assessment.description }}</p>

      <div class="card bg-light">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>Questions:</strong> {{ assessment.questions_count }}
            </div>
            <div class="col-md-3">
              <strong>Time:</strong> {{ assessment.time_required }} min
            </div>
            <div class="col-md-3">
              <strong>Type:</strong> {{ assessment.get_assessment_type_display }}
            </div>
            <div class="col-md-3">
              <strong>Progress:</strong>
              <div class="progress">
                <div class="progress-bar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if existing_result %}
  <div class="alert alert-info">
    <h5>You've already completed this assessment!</h5>
    <p>You completed this assessment on {{ existing_result.completed_at|date:"M d, Y" }}</p>
    <a href="{% url 'assessment_results' existing_result.id %}" class="btn btn-primary">View Results</a>
    <a href="?retake=true" class="btn btn-outline-primary">Retake Assessment</a>
  </div>
  {% endif %}

  <form method="post" id="assessment-form">
    {% csrf_token %}

    {% for question in questions %}
    <div class="assessment-question" id="question-{{ question.id }}" {% if not forloop.first %}style="display: none;" {%
      endif %}>
      <h4 class="mb-4">Question {{ forloop.counter }} of {{ questions|length }}</h4>
      <p class="lead">{{ question.text }}</p>

      <div class="choices-container">
        {% for choice in question.choices.all %}
        <div class="choice-option" data-question="{{ question.id }}" data-choice="{{ choice.id }}">
          <input type="radio" name="question_{{ question.id }}" value="{{ choice.id }}" id="choice_{{ choice.id }}"
            class="visually-hidden">
          <label for="choice_{{ choice.id }}" class="w-100 h-100 d-block p-3">
            {{ choice.text }}
          </label>
        </div>
        {% endfor %}
      </div>

      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-secondary prev-btn" {% if forloop.first %}disabled{% endif %}>
          Previous
        </button>
        <button type="button" class="btn btn-primary next-btn">
          {% if forloop.last %}Complete Assessment{% else %}Next Question{% endif %}
        </button>
      </div>
    </div>
    {% endfor %}
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const questions = document.querySelectorAll('.assessment-question');
    const progressBar = document.querySelector('.progress-bar');
    let currentQuestion = 0;

    function showQuestion(index) {
      questions.forEach((q, i) => {
        q.style.display = i === index ? 'block' : 'none';
      });

      // Update progress
      const progress = ((index + 1) / questions.length) * 100;
      progressBar.style.width = `${progress}%`;

      // Update button states
      document.querySelector('.prev-btn').disabled = index === 0;
    }

    // Choice selection
    document.querySelectorAll('.choice-option').forEach(option => {
      option.addEventListener('click', function () {
        const questionId = this.dataset.question;
        const choiceId = this.dataset.choice;

        // Remove selected class from all choices in this question
        document.querySelectorAll(`[data-question="${questionId}"]`).forEach(opt => {
          opt.classList.remove('selected');
        });

        // Add selected class to clicked choice
        this.classList.add('selected');

        // Update radio button
        document.getElementById(`choice_${choiceId}`).checked = true;
      });
    });

    // Navigation
    document.querySelectorAll('.next-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          showQuestion(currentQuestion);
        } else {
          // Submit form on last question
          document.getElementById('assessment-form').submit();
        }
      });
    });

    document.querySelectorAll('.prev-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        if (currentQuestion > 0) {
          currentQuestion--;
          showQuestion(currentQuestion);
        }
      });
    });

    // Initialize
    showQuestion(0);
  });
</script>
{% endblock %}